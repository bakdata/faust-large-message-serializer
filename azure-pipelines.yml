
stages:
- stage: Testing
  jobs:
  - job: 'Test'
    pool:
      vmImage: 'ubuntu-16.04'
    strategy:
      matrix:
        Python36:
          python.version: '3.6'
        Python37:
          python.version: '3.7'
        Python38:
          python.version: '3.8'

    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(python.version)'

    - script: pip install flit
      displayName: 'Install flit build tool'

    - script: flit install --symlink
      displayName: 'Install library and its dependencies'

    - script: pytest
      displayName: 'Test with pytest'

- stage: "Publish"
  pool:
    vmImage: 'ubuntu-16.04'
  jobs:
    - job: "PublishPyPi"
      steps:
        - task: UsePythonVersion@0
          inputs:
            versionSpec: '3.8'

        - script: pip install flit
          displayName: "Install flit"

        - script: flit install
          displayName: "Install library"

        - script: |
            git config user.email "31185348+bakdata-bot@users.noreply.github.com"
            git config user.name "bakdata-bot"
            git fetch
            git status
            git branch
            git checkout $(Build.SourceBranchName)
          displayName: "Setting GitHub author"

        - script: bump2version minor
          displayName: "Bump version"

        - script: git push --follow-tags origin $(Build.SourceBranchName)
          displayName: "Pushing tag to github"

